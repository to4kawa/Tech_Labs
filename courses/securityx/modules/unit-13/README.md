# Unit 13: Capstone — 端末汚染前提の「通信不能/検知可能」設計実装

> 17日設計（目安）: 第1部1日 / 第2部3日 / 第3部4日 / 第4部3日 / 第5部4日 / 第6部2日 / 第7部評価固定

## 0. 目的と到達ゴール（固定）
- 本ユニットのゴールは1つだけ: **「端末が汚染されても、通信が成立しない／成立しても証拠で検知できる」状態を、設計・実装・運用・監査まで一通り作れること。**
- 端末の表示・端末内ログ・ユーザ操作を信頼せず、外側観測と外側制御で担保する。
- 本教材は防御・監査・統制目的のみ。攻撃/悪用手順は扱わない。

## 1. 前提条件
- 受講者は Unit-01〜Unit-12 の基礎（証跡重視、最小権限、監査ログ確認）を履修済み。
- 検証用ネットワーク（分離された学習環境）を用意する。
- ゲートウェイ側で以下を記録できること。
  - フローログ（L3/L4）
  - DNSログ
  - HTTP/HTTPSメタデータログ
  - システム時刻同期ログ（NTP関連）

## 2. 全体ロードマップ（章ごとの狙い）
1. **第1部: 前提の破壊（1日）**
   - 幻想を壊す。鍵マーク/端末ログ/ユーザ操作を安全根拠にしない。
2. **第2部: 観測（3日）**
   - 神視点を「質問で得る」のではなく「仕組みで作る」。
3. **第3部: 制御（4日）**
   - 端末依存ではなく外側制御で、通信不能条件を積み上げる。
4. **第4部: MITM（3日）**
   - TLS系と非TLS系を比較し、「成立条件の差」を証跡で理解する。
5. **第5部: 迂回・抜け道（4日）**
   - well-known暗記ではなく、抜け道の発見→封鎖を反復する。
6. **第6部: 運用（2日）**
   - 例外・監査・変更管理・継続観測を組み込み、現場で崩れない形にする。
7. **第7部: 評価（固定）**
   - 提出物・合否を最初から固定し、主張と証拠を一致させる。

---

## 3. 章別手順・観測項目・チェックリスト

### 第1部: 前提の破壊（Day 1）
**狙い**
- 「安全そうに見える」情報を排除し、未知を未知として扱う。

**手順**
1. あえて情報不足の環境説明を提示する。
2. 受講者は断定を禁止し、「何が分からないか」を列挙する。
3. 列挙した未知を、観測で埋めるための計測計画に変換する。

**観測項目**
- まだ収集しない。ここでは「必要証拠の定義」が成果物。

**チェックリスト**
- [ ] 「端末がそう言っている」を根拠にしていない
- [ ] 未知項目をネットワーク層/名前解決層/アプリ層で分解した
- [ ] 次章で収集するログ種別が明確

**合格条件**
- 「分からないこと一覧」を提出し、神視点の捏造がない。

### 第2部: 観測（Day 2-4）
**狙い**
- 外側観測で再現可能な事実を作る。

**手順**
1. ゲートウェイでL3/L4全フロー収集を開始。
2. DNSクエリ/レスポンスを記録。
3. HTTPメタデータ（Host/URL/Status）を必要範囲で取得。
4. HTTPSは復号を前提にせず、SNI/ALPN/宛先IP/証明書情報を取得。
5. NTP/QUIC/ICMP/DHCP/SMTPなど非主流通信を同じ粒度で記録。
6. 端末の実通信をプロトコル別に棚卸しする。

**観測項目（最低必須）**
- L3/L4: src/dst IP, src/dst port, protocol, timestamp
- DNS: query name, query type, response code, answer set
- HTTP: host, url path, method, status
- HTTPS: SNI, ALPN, dst IP, cert subject/issuer/validity
- Others: NTP(UDP/123), QUIC(UDP/443), ICMP, DHCP, SMTP

**チェックリスト**
- [ ] 収集対象に「その他プロトコル」が含まれる
- [ ] 同一時刻帯で複数ログを突合できる
- [ ] 「暗記」ではなく実測の通信一覧を作成した

**合格条件**
- プロトコル別通信一覧を、再現可能なログ根拠付きで説明できる。

### 第3部: 制御（Day 5-8）
**狙い**
- 外側で段階的に制御を積み、「許可通信だけ成立」を証明する。

**規定路線（必ずこの順）**
1. 経路一本化（出口固定）
2. L3/L4 egress制御（proto/port/ip）
3. DNS制御（resolver固定・直DNS遮断・DoH対策足場）
4. HTTP制御（プロキシ経由強制）
5. HTTPS行き先制限（SNI/IP allowlist、QUIC方針）
6. サーバ側拒否（mTLS/短命トークン/最小権限）

**手順**
1. 無制限状態でベースラインを取得。
2. 上記1〜6を1段ずつ適用。
3. 各段で「止まった通信/残った通信」を記録。
4. 許可通信定義（allowlist）を更新。

**観測項目**
- 段階ごとの差分（許可/拒否イベント）
- 拒否理由（rule id / policy name / server reject reason）
- QUICや直IPの残存有無

**チェックリスト**
- [ ] 制御段ごとに差分証跡がある
- [ ] allowlistに理由列がある
- [ ] 端末設定依存でなく外側制御で担保している

**合格条件**
- 「許可された通信だけ成立」をログで示せる。

### 第4部: MITM（Day 9-11）
**狙い**
- MITMを“途中に入る現象”として理解し、TLS系/非TLS系の成立条件を比較する。

**イベント構成（固定）**
- A: 正常（基準）
- B: MITM介入（拒否される）
- C: MITM介入（成立してしまう）

**教材系統（両方必須）**
- TLS系: 証明書・信頼差分でB/Cの分岐を確認
- 非TLS系: NTPなどで静かな異常を観測から検知

**手順**
1. A/B/Cそれぞれで通信ログと判定ログを取得。
2. TLS系は「どの信頼条件で通過したか」を整理。
3. 非TLS系は「エラーが出ないのに異常」を時系列崩れ等で検知。
4. 制御策（遮断/固定/監視）を適用して再判定。

**観測項目**
- TLS: cert chain, trust decision, hostname validation result
- 非TLS: 時刻ドリフト、ログ順序不整合、同期先逸脱

**チェックリスト**
- [ ] BとCの差を信頼条件で説明できる
- [ ] 非TLSの静かな異常を検知証跡で示せる
- [ ] 対策前後の比較がある

**合格条件**
- TLS/非TLS双方で「成立条件」と「潰し方」を説明できる。

### 第5部: 迂回・抜け道（Day 12-15）
**狙い**
- 網羅性を鍛える。抜け道を発見し、制御を1段積む。

**必須トピック（全部実施）**
- QUIC/HTTP3（UDP/443）
- DoH/DoT
- VPN/トンネル（443偽装含む）
- 直IPアクセス
- NTP/DHCP等の地味な外部通信
- IPv6経路
- テザリング/別NIC

**手順**
1. 制御済み環境へ抜け道シナリオを段階投入。
2. 受講者は外側ログだけで異常通信を特定。
3. 追加制御を適用し、再度抜けないことを確認。
4. 迂回リストと対策マップを更新。

**観測項目**
- 新規に出現したdst/port/proto
- 既存allowlistとの不一致
- 経路情報（IPv4/IPv6, NIC差分）

**チェックリスト**
- [ ] 検知→封じ込め→再検証が1セットで回っている
- [ ] 物理経路の抜け道を机上で終わらせていない
- [ ] 迂回対策を制御段にマッピング済み

**合格条件**
- 「抜けた通信」を外側ログで同定し、対策を追加できる。

### 第6部: 運用（Day 16-17）
**狙い**
- 例外が増えても統制が崩れない運用設計を作る。

**手順**
1. 例外申請テンプレ（期限/理由/承認者/棚卸し日）を定義。
2. 監査証跡（誰がいつ何を許可したか）を保存。
3. 変更管理フロー（申請→審査→実装→検証→失効）を文書化。
4. 継続観測の閾値・アラート・当番連絡先を設定。

**観測項目**
- 例外件数推移
- 期限切れ例外の残存
- 変更後に増えた通信の有無

**チェックリスト**
- [ ] 例外に期限がある
- [ ] 期限切れ自動検出または定期棚卸しがある
- [ ] 監査時に変更根拠を提示できる

**合格条件**
- 例外運用込みで「通信できてない」担保が維持される。

---

## 4. 第7部: 評価（提出物と合否を固定）

### 提出物（A/B/C選択なし・全員共通）
1. 現状の全通信棚卸し（ログ根拠付き）
2. 許可通信定義（allowlist: proto/port/dst/理由）
3. 迂回経路リストと対策マップ（どの制御で潰したか）
4. MITM観測結果（TLS系 + 非TLS系）
5. 「使える/使えない」判定基準（監査可能形式）
6. 例外運用ルール（期限/承認/棚卸し）

### 合否基準（固定）
- ログ根拠がない主張は不合格
- 「端末がそう言っている」は不合格
- 迂回が残っているのに「使える」判定は不合格
- 例外が無制限に増える設計は不合格

---

## 5. 提出テンプレート（最小）
```text
/evidence
  /01_inventory
  /02_allowlist
  /03_bypass_map
  /04_mitm_tls_non_tls
  /05_judgement_criteria
  /06_exception_ops
```

## 6. 実施後レビュー
- 良かった点: 観測/制御/運用のどこで再現性が高かったか
- 課題: まだ手作業に依存している判定はどれか
- 次アクション: 自動化候補を3件まで優先順位付きで登録

## 7. クイズと採点
- 理解確認は `quiz.md`。
- 採点と合否判定は `rubric.md`（固定基準）を使用する。

## Colabメモ
- `notebook.ipynb` に章ごとの証跡リンク、判定理由、例外管理記録を残す。
